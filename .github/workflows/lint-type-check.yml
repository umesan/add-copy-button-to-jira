###
# GitHub ã¸ pushæ™‚ã« yarn lint, yarn type-checkã‚’å®Ÿè¡Œã™ã‚‹ workflow
#
# å‚è€ƒæ§‹æˆ
# https://dev.classmethod.jp/articles/caching-dependencies-in-workflow-execution-on-github-actions/
# https://github.com/ferraobox/todoist-jira/blob/c0b661a0ab895eef67b44d0c22526653feedf418/.github/workflows/ci.yml
# https://github.com/brionmario/dev-server-ports/blob/d38013018f30bae2813f6395b74d9dca975452f4/.github/workflows/pr-yarner.yml
#
# actions/cacheã®èª¬æ˜
# https://www.kaizenprogrammer.com/entry/2019/12/15/220137#actionscache
#
###
name: lint & type-check

on: push

env:
  NODE_VERSION: 16.5.0

jobs:
  setup:
    name: ğŸ”° Setup
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v3

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”† Cache Yarn Dependencies
        uses: actions/cache@v3
        id: yarn-cache
        with:
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ã—ã¦ä¿å­˜ï¼†å¾©å…ƒã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒ‘ã‚¹ï¼ˆæŒ‡å®šã§ãã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ä¸€ã¤ï¼‰
          path: "**/node_modules"
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ï¼†å¾©å…ƒã™ã‚‹ãŸã‚ã®key
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¾©å…ƒæ™‚ã« key ã«å®Œå…¨ã«ä¸€è‡´ã™ã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå­˜åœ¨ã—ãªã„ã¨ãã«ä½¿ã‚ã‚Œã‚‹keyã®ãƒªã‚¹ãƒˆ
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: ğŸ‘€ Show Yarn Cache
        run: echo '${{ toJSON(steps.yarn-cache.outputs) }}'

      - name: ğŸ± Yarn Install
        # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã‘ã‚Œã° yarn installã‚’å®Ÿè¡Œ
        if: steps.yarn-cache.outputs.cache-hit != 'true'
        # yarn installæ™‚ã«
        # --frozen-lockfile lockãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ãªã„
        # --silent logã‚’è¡¨ç¤ºã—ãªã„
        run: yarn install --frozen-lockfile --silent

  lint:
    needs:
      - setup
    name: Lint(stylelint, eslint, prettier)
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v3

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”† Cache Yarn Dependencies
        uses: actions/cache@v3
        id: yarn-cache
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      - name: ğŸ’… yarn lint(stylelint, eslint, prettier)
        run: yarn lint

  type-check:
    needs:
      - setup
    name: TypeCheckï¼ˆtscï¼‰
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“ Checkout
        uses: actions/checkout@v3

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ”† Cache Yarn Dependencies
        uses: actions/cache@v3
        id: yarn-cache
        with:
          path: "**/node_modules"
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      - name: ğŸ‘ yarn type-check
        run: yarn type-check
